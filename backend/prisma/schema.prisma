// Datasource
datasource db {
	provider = "postgresql"
	url      = env("DATABASE_URL")
}

// Generator
generator client {
	provider = "prisma-client-js"
}

model Ward {
	id                 String   @id @default(uuid()) @db.Uuid
	name               String
	hourlyGranularity  Boolean  @default(false)

	// Organisational hierarchy (nullable)
	hospitalId String? @db.Uuid
	hospital   Hospital? @relation(fields: [hospitalId], references: [id], onDelete: SetNull)

	// Timestamps
	createdAt DateTime @default(now())
	updatedAt DateTime @updatedAt

	// Relations
	staff     Staff[] @relation("StaffWards")
	demands   Demand[]
	schedules Schedule[]
	assignments Assignment[]
	skills    WardSkill[]

	@@index([hospitalId])
}



model Skill {
	id        String @id @default(uuid()) @db.Uuid
	code      String @unique
	name      String

	// Timestamps
	createdAt DateTime @default(now())
	updatedAt DateTime @updatedAt

	// Relations
	staff     Staff[] @relation("StaffSkills")
	wards     WardSkill[]
}

model JobRole {
	id        String @id @default(uuid()) @db.Uuid
	code      String @db.VarChar(64)
	name      String @db.VarChar(160)
	
	// Organisational hierarchy (nullable)
	scope      String? @db.VarChar(20) // 'TRUST', 'HOSPITAL'
	trustId    String? @db.Uuid
	hospitalId String? @db.Uuid
	
	// Relations
	trust    Trust?    @relation(fields: [trustId], references: [id], onDelete: SetNull)
	hospital Hospital? @relation(fields: [hospitalId], references: [id], onDelete: SetNull)
	staff    Staff[]

	// Timestamps
	createdAt DateTime @default(now())
	updatedAt DateTime @updatedAt

	@@unique([scope, trustId, hospitalId, code])
	@@index([scope, trustId, hospitalId])
}

model WardSkill {
	wardId    String @db.Uuid
	skillId   String @db.Uuid
	ward      Ward  @relation(fields: [wardId], references: [id], onDelete: Cascade)
	skill     Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)
	createdAt DateTime @default(now())

	@@id([wardId, skillId])
	@@index([skillId])
}

model Staff {
	id                    String     @id @default(uuid()) @db.Uuid
	prefix                String?
	firstName             String
	lastName              String
	fullName              String     @default("")
	role                  StaffRole
	gradeBand             String?
	contractHoursPerWeek  Float
	active                Boolean @default(true)

	// Job Role
	jobRoleId String @db.Uuid
	jobRole   JobRole @relation(fields: [jobRoleId], references: [id])

	// Many-to-many
	wards  Ward[] @relation("StaffWards")
	skills Skill[] @relation("StaffSkills")

	// Relations
	assignments Assignment[]
	preferences Preference[]

	@@index([jobRoleId])
}

enum StaffRole {
	doctor
	nurse
}

model ShiftType {
	id              String @id @default(uuid()) @db.Uuid
	code            String @unique
	name            String
	startTime       String
	endTime         String
	isNight         Boolean
	durationMinutes Int

	// Organisational hierarchy (nullable)
	scope      String? @db.VarChar(20) // 'TRUST', 'HOSPITAL', 'WARD', 'SCHEDULE'
	trustId    String? @db.Uuid
	hospitalId String? @db.Uuid
	wardId     String? @db.Uuid

	assignments Assignment[]

	@@index([scope, trustId, hospitalId, wardId])
	@@unique([scope, trustId, hospitalId, wardId, code])
}

model Demand {
	id               String      @id @default(uuid()) @db.Uuid
	wardId           String      @db.Uuid
	ward             Ward        @relation(fields: [wardId], references: [id])
	date             DateTime
	granularity      Granularity
	slot             String
	requiredBySkill  Json

	@@index([wardId, date, slot])
}

enum Granularity {
	shift
	hour
}



model Schedule {
	id           String         @id @default(uuid()) @db.Uuid
	wardId       String         @db.Uuid
	ward         Ward           @relation(fields: [wardId], references: [id])
	horizonStart DateTime
	horizonEnd   DateTime
	objective    String?
	status       ScheduleStatus @default(draft)
	createdAt    DateTime       @default(now())
	updatedAt    DateTime       @updatedAt

	// Relations
	assignments Assignment[]
	events      Event[]
	locks       Lock[]

	@@unique([wardId, status])
}

enum ScheduleStatus {
	draft
	published
}

model Assignment {
	id           String     @id @default(uuid()) @db.Uuid
	scheduleId   String     @db.Uuid
	schedule     Schedule   @relation(fields: [scheduleId], references: [id])
	wardId       String     @db.Uuid
	ward         Ward       @relation(fields: [wardId], references: [id])
	staffId      String     @db.Uuid
	staff        Staff      @relation(fields: [staffId], references: [id])
	shiftTypeId  String     @db.Uuid
	shiftType    ShiftType  @relation(fields: [shiftTypeId], references: [id])
	date         DateTime
	slot         String
	createdAt    DateTime   @default(now())
	updatedAt    DateTime   @updatedAt

	@@index([scheduleId])
	@@index([wardId, date, slot])
}

model Lock {
	id         String   @id @default(uuid()) @db.Uuid
	scheduleId String   @db.Uuid
	schedule   Schedule @relation(fields: [scheduleId], references: [id])
	staffId    String   @db.Uuid
	wardId     String   @db.Uuid
	date       DateTime
	slot       String

	@@index([scheduleId])
}

model Preference {
	id        String   @id @default(uuid()) @db.Uuid
	staffId   String   @db.Uuid
	staff     Staff    @relation(fields: [staffId], references: [id])
	date      DateTime
	preferOff Boolean?
	preferOn  Boolean?
}

model Event {
	id         String   @id @default(uuid()) @db.Uuid
	scheduleId String   @db.Uuid
	schedule   Schedule @relation(fields: [scheduleId], references: [id])
	type       String
	payload    Json
	createdAt  DateTime @default(now())
}

model Policy {
	id           String @id @default(uuid()) @db.Uuid
	scope        String @db.VarChar(20) // 'TRUST', 'HOSPITAL', 'WARD'
	orgId        String?
	wardId       String?
	weights      Json
	limits       Json
	toggles      Json
	substitution Json
	timeBudgetMs Int
	label        String
	isActive     Boolean @default(true)
	createdAt    DateTime @default(now())
	updatedAt    DateTime @updatedAt

	// Organisational hierarchy (nullable)
	trustId    String? @db.Uuid
	hospitalId String? @db.Uuid

	// Rules directly embedded in Policy
	rules      Json     // Array of rule objects

	@@unique([scope, orgId, wardId])
	@@index([scope, trustId, hospitalId, wardId, isActive])
}

// ============================================================================
// ORGANISATIONAL HIERARCHY (ADDITIVE ONLY - NO BREAKING CHANGES)
// ============================================================================

// Scope levels are string-based for flexibility
// Valid values: 'TRUST', 'HOSPITAL', 'WARD', 'SCHEDULE'

model Trust {
	id        String     @id @default(uuid()) @db.Uuid
	name      String     @unique @db.VarChar(120)
	createdAt DateTime   @default(now())
	updatedAt DateTime   @updatedAt

	// Relations
	hospitals Hospital[]
	jobRoles  JobRole[]
}

model Hospital {
	id        String   @id @default(uuid()) @db.Uuid
	name      String   @db.VarChar(120)
	trustId   String?  @db.Uuid
	trust     Trust?   @relation(fields: [trustId], references: [id], onDelete: SetNull)
	createdAt DateTime @default(now())
	updatedAt DateTime @updatedAt

	// Relations
	wards    Ward[]
	jobRoles JobRole[]

	@@index([trustId])
	@@unique([trustId, name])
}

